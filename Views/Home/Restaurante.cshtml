@{
    Layout = "_Layout";
}

@* 1. Encabezado del Restaurante *@
@if (ViewBag.Restaurante != null)
{
    <h2>@ViewBag.Restaurante.nombre</h2>
    <hr />
}
else
{
    <h2>Resultados de Restaurante</h2>
}

@* 2. Platos Disponibles *@
<h3>Platos Disponibles</h3>
@if (ViewBag.PlatosRestaurante != null && ViewBag.PlatosRestaurante.Count > 0)
{
    @foreach (var p in ViewBag.PlatosRestaurante)
    {
        <div class="item-plato">
            <a class="btn btn-primary" href='@Url.Action("verPlato", "Home", new {idPlato= p.idPlato})'>
                @p.nombre
            </a>
            
            <p><strong>Descripción:</strong> @p.descripcion</p>
            <p><strong>Calorías:</strong> @p.calorias</p>
            <p><strong>Precio:</strong> $@p.precio</p>
        </div>
        <br/>
    }
}
else
{
    <p>No se encontraron platos para este restaurante.</p>
}

@* 3. Bebidas Disponibles *@
<h3>Bebidas Disponibles</h3>
@if (ViewBag.BebidasRestaurante != null && ViewBag.BebidasRestaurante.Count > 0)
{
    @foreach (var b in ViewBag.BebidasRestaurante)
    {
        <div class="item-bebida">
            <a class="btn btn-primary" href='@Url.Action("verBebida", "Home", new {idBebida= b.idBebida})'>
                @b.nombre
            </a>
            
            <p><strong>Descripción:</strong> @b.descripcion</p>
        </div>
        <br/>
    }
}
else
{
    <p>No se encontraron bebidas para este restaurante.</p>
}

@* 4. Contenedor HTML del Mapa *@
@if (ViewBag.Restaurante != null)
{
    <h3 class="mt-4">Ubicación de @ViewBag.Restaurante.nombre</h3>
    <div id="mapa" style="height: 350px; width: 100%; margin-bottom: 20px;"></div>
}

<script>
    let map;
    let markers = [];
    
    // 1. OBTENER TODOS LOS RESTAURANTES DE LA VISTA
    // Asegúrate de que ViewBag.RestaurantesJson contenga una lista COMPLETA
    // de objetos { nombre, latitud, longitud, tipoComida (o idCategoria) }
    const todosLosRestaurantes = @Html.Raw(ViewBag.RestaurantesJson); 
    
    // Si estás en una vista de listado o mapa general, puedes centrar en CABA.
    // Si es la vista de un solo restaurante, centrar en él (como en el Escenario A anterior).
    window.initMap = function () {
        map = new google.maps.Map(document.getElementById("mapa"), { // Asegúrate de que el ID del div es 'mapa'
            center: { lat: -34.6089, lng: -58.4311 }, // Centro en CABA
            zoom: 13,
        });

        // 2. Cargar todos los marcadores al inicio
        cargarMarcadores(todosLosRestaurantes);

        // 3. AGREGADO — escuchar cambios en los radios
        document.querySelectorAll('.donar-panel input[type="radio"]').forEach(r => {
            r.addEventListener("change", () => {
                // 4. Llamar a la función de filtrado con el valor del radio (ej: 'Vegano' o '3')
                filtrarUbicaciones(r.value); 
            });
        });
    };

    function cargarMarcadores(lista) {
        // Limpiar marcadores existentes del mapa
        markers.forEach(m => m.setMap(null));
        markers = [];

        lista.forEach(u => {
            const marker = new google.maps.Marker({
                // Usamos las propiedades correctas de tu modelo
                position: { lat: u.latitud, lng: u.longitud },
                map,
                title: u.nombre, 
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 5,
                    strokeColor: "#0112EB",
                    rotation: 180 
                }
            });

            markers.push(marker);
        });
    }

    /**
     * Filtra la lista de restaurantes que ya tenemos en memoria.
     *  {string} filtroValor - El valor por el que filtrar (ej: 'Vegano', 'Bowl', o un ID)
     */
    function filtrarUbicaciones(filtroValor) {
        let listaFiltrada;

        // Si el valor es 'todos' o está vacío, mostramos la lista completa.
        if (filtroValor === 'todos' || !filtroValor) {
            listaFiltrada = todosLosRestaurantes;
        } else {
            // Filtrado basado en el valor. Ajusta la propiedad de tu objeto (u.tipoComida o u.idCategoria)
            // Aquí asumo que quieres filtrar por la propiedad 'tipoComida' o 'idCategoria' del objeto Restaurante.
            listaFiltrada = todosLosRestaurantes.filter(u => 
                u.tipoComida.toLowerCase() === filtroValor.toLowerCase() // Ejemplo 1: Filtrar por el campo 'tipoComida'
                // O si usas idCategoria: u.idCategoria.toString() === filtroValor 
            );
        }

        // 5. Cargar los marcadores filtrados en el mapa
        cargarMarcadores(listaFiltrada);

        // 6. Si tenías la función para actualizar otro panel (Campañas/Platos)
        // Puedes implementar la lógica de filtrado del otro panel aquí mismo.
        // actualizarPanel(listaFiltrada); 
    }
    
    // ... (Tu función actualizarPanelCampanas si todavía la necesitas) ...
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap"></script>
}